# OrbitSpot Actions - AI Coding Assistant Instructions

## Architecture Overview

This is OrbitSpot's centralized GitHub Actions repository providing reusable workflows for deploying Node.js applications, APIs, ScaledJobs, and infrastructure to Kubernetes via GitOps. The system follows a **branch-environment mapping** pattern where branch names correspond to deployment environments.

### Core Workflow Pattern

All workflows follow this multi-job pipeline:
1. **setup-config** - Validates variables, fetches devops config, generates deployment matrix
2. **building** - Installs dependencies using package managers 
3. **generate-docker** - Builds container images (matrix strategy for multiple deployments)
4. **prepare-helm-chart-values** - Processes Helm templates with variable substitution
5. **deploy** - Helm deployment to Kubernetes with proper namespacing

### Key Architecture Decisions

- **Self-hosted runners**: All jobs use `['${{ github.ref_name }}', '${{ inputs.module }}', linux, self-hosted, x64]` pattern
- **Matrix deployments**: Dynamic matrix generation from `.github/scripts/*.sh` files for multi-service repos
- **Template-driven configuration**: Helm values use `${.<REPO>.<DEPLOYMENT>.property}` placeholder system
- **Branch-based environments**: `github.ref_name` maps directly to Kubernetes namespaces and environments

## Developer Workflows

### Testing Actions Locally
```bash
# Test variable validation
export variables_json='{"_PROPERTIES_API": "api.replicas=3"}' setup='api'
python .github/scripts/check-required-variables.py

# Test Helm template processing  
export PROPERTIES_PATH=test.properties YAML_PATH=values.yaml PREFIX='.<repo>.<deployment>'
python .github/scripts/replace-properties.py
```

### Required Repository Variables

Each consuming repository must define these GitHub repository variables based on deployment type:

**For APIs (`setup: api`):**
- `_PROPERTIES_API` - Properties like `api.replicas=3\napi.node_selector=nodegroup-api`
- `_POLICY_JSON` - IAM policy JSON for service account

**For ScaledJobs (`setup: scaledjob`):**
- `_PROPERTIES_SCALEDJOB` - Consumer properties like `consumer.maxReplicas=10`  
- `_POLICY_JSON` - IAM policy JSON

**For Migrations (`setup: migration`):**
- `_PROPERTIES_MIGRATION` - Migration-specific properties

### Property System Conventions

Properties follow the pattern `<deployment-name>.<property>=<value>`:

```properties
# _PROPERTIES_API example
api.replicas=3
api.node_selector=nodegroup-api  
api.resources.requests.cpu=100m
api.resources.requests.memory=256Mi
api.keda.maxReplicaCount=10
api.keda.minReplicaCount=1

# _PROPERTIES_SCALEDJOB example  
consumer.maxReplicas=20
consumer.node_selector=nodegroup-worker
processor.maxReplicas=5
```

## Code Patterns & Conventions

### Workflow Input Conventions
- **ENVs**: UPPERCASE for environment variables shared across jobs
- **with**: lowercase for action-specific inputs 
- Always use single quotes for parameters (GitHub expects strings)
- Set ENVs at job level if multiple steps need them

### Action Development Patterns
```yaml
# Standard action structure
runs:
  using: composite
  steps:
    - name: Setup Python  # Always include for script actions
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Checkout script repository  # For accessing shared scripts
      uses: actions/checkout@v4
      with:
        repository: 'orbitspot/actions'
        path: orbitspot-actions
        ref: 'v20.6.1'  # Always pin to specific version
```

### Helm Template Processing

1. **Copy base template**: From `helm-values/<chart_type>/values.yaml`
2. **Replace placeholders**: `${.<REPO>.<DEPLOYMENT>.property}` → actual values
3. **Replace static tags**: `<GRAFANA-TAG>`, `<REPOSITORY-NAME>` → runtime values
4. **Upload as artifact**: For consumption by deploy job

### Matrix Strategy Generation

Dynamic matrices are generated by scanning `.github/scripts/*.sh` files:
```python
# From node_api.yaml setup-config job
scripts=($(find "$SCRIPT_DIR" -maxdepth 1 -type f -name "*.sh" -exec basename {} .sh \;))
matrix=$(printf '%s\n' "${scripts[@]}" | jq -R . | jq -cs 'map(select(contains("cronjob") | not))')
```

## Integration Points

### External Dependencies
- **AWS ECR**: Container registry `931670397156.dkr.ecr.${region}.amazonaws.com`
- **Kubernetes**: Target clusters defined in `_DEVOPS_CONFIG` organization variable
- **Helm Charts**: OrbitSpot's internal chart repository
- **AWS Parameter Store**: For secrets/config via `/repo/environment/` and `/repo/secret/` paths

### Cross-Component Communication
- **Artifacts**: Helm values, Docker contexts passed between jobs via `actions/upload-artifact`
- **Outputs**: Job outputs like `CLUSTER_REGION`, `PROPERTIES` flow between jobs
- **Environments**: GitHub environments provide branch-specific variables and approvals

### DevOps Config Structure
The `_DEVOPS_CONFIG` organization variable contains branch-specific settings:
```json
{
  "develop": {"cluster": "dev-cluster", "region": "us-east-1"},
  "staging": {"cluster": "staging-cluster", "region": "us-east-1"}, 
  "main": {"cluster": "prod-cluster", "region": "us-west-2"}
}
```

## Common Debugging Patterns

- **Check artifacts**: Use "Download Building files" step to verify Helm values processing
- **Variable validation**: The `check-required-variables.py` script validates all required vars per deployment type
- **Matrix debugging**: Check the `set-matrix` step output to verify dynamic matrix generation
- **Template issues**: Look for placeholder substitution problems in `replace-properties.py` execution

## File Relationships

- `helm-values/*/values.yaml` → Base templates for different deployment types
- `.github/scripts/*.py` → Property processing and validation logic  
- `.github/actions/*/action.yaml` → Reusable composite actions
- `.github/workflows/*.yaml` → Main workflow orchestration per deployment type
name: 'Kubernetes authenticate'
description: 'Generate kube config file'
inputs:
  s3_chart_location:
    description: 'S3 template location'
    required: false
    default: 's3://devops.orbitspot.com/charts/'
runs:
  using: composite
  steps:
  - name: configure aws credentials
    uses: aws-actions/configure-aws-credentials@v4
    with:
      role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_NUMBER }}:role/${{ env.AWS_ROLE_NAME }}
      role-session-name: ${{ env.AWS_ROLE_NAME }}
      aws-region: ${{ env.CLUSTER_REGION }}

  - name: Install kubectl
    shell: bash
    run: |
      aws s3 cp s3://continuous-integration-files/binaries/kubectl/1.21/bin ./kubectl
      chmod +x ./kubectl
      sudo mv ./kubectl /usr/local/bin/

  - name: Install aws-iam-authenticator
    shell: bash
    run: |
      aws s3 cp s3://continuous-integration-files/binaries/aws-iam-authenticator/bin ./aws-iam-authenticator
      chmod +x ./aws-iam-authenticator
      sudo mv ./aws-iam-authenticator /usr/local/bin/

  - name: Install Helm
    shell: bash
    run: |
      sudo apt-get install curl gpg apt-transport-https --yes
      curl -fsSL https://packages.buildkite.com/helm-linux/helm-debian/gpgkey | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
      echo "deb [signed-by=/usr/share/keyrings/helm.gpg] https://packages.buildkite.com/helm-linux/helm-debian/any/ any main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
      sudo apt-get update
      sudo apt-get install helm

  - name: Cache Helm plugins
    id: cache-helm-plugins
    uses: actions/cache@v4
    with:
      path: ~/.local/share/helm/plugins/
      key: ${{ runner.os }}-helm-plugins-${{ hashFiles('role.json') }}
      restore-keys: |
        ${{ runner.os }}-helm-plugins-

  - name: Install Plugins Helm Git
    shell: bash
    run: |
      if ! helm plugin list | grep -q "helm-git"; then
        helm plugin install https://github.com/aslafy-z/helm-git.git
      else
        echo "helm-git plugin already installed"
      fi

  - name: Install Plugins Helm s3
    shell: bash
    run: |
      if ! helm plugin list | grep -q "helm-s3"; then
        helm plugin install https://github.com/hypnoglow/helm-s3.git
      else
        echo "helm-s3 plugin already installed"
      fi

  - name: Add Helm repository
    shell: bash
    run: helm repo add orbitspot ${{ inputs.s3_chart_location }}

  - name: update-k8s-config
    shell: bash
    run: |
      echo "ClusterName: $CLUSTER_NAME"
      echo "Region: $CLUSTER_REGION"
       aws eks update-kubeconfig --region $CLUSTER_REGION --name $CLUSTER_NAME

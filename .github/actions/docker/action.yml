name: 'Generate Docker Image on Ecr'
description: 'Create and publish docker image'
inputs:
  aws_account_number:
    description: 'Account Number'
    required: true
  aws_role_name:
    description: 'Aws role with polices to deploy'
    required: true
  aws_region: 
    description: 'Aws region'
    required: true
  content:
    description: 'Content to download'
    required: false
  image:
    description: 'Image Name'
    required: true
  tag:
    description: 'Image Tag'
    required: true
  before_building:
    description: 'Before image callback'
    required: false
  build_args: 
    description: 'Building docker args'
    required: false

runs:
  using: composite
  steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::${{ inputs.aws_account_number }}:role/${{ inputs.aws_role_name }}
        role-session-name: ${{ inputs.aws_role_name }}
        aws-region: ${{ inputs.aws_region }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Ensure ECR Repository Exists
      shell: bash
      run: |
        echo "üîπ Verificando se o reposit√≥rio ECR ${{ inputs.image }} existe..."
        if ! aws ecr describe-repositories --repository-names "${{ inputs.image }}" >/dev/null 2>&1; then
          echo "‚ö†Ô∏è  Reposit√≥rio n√£o existe. Criando..."
          aws ecr create-repository --repository-name "${{ inputs.image }}"
        else
          echo "‚úÖ Reposit√≥rio ECR j√° existe."
        fi

    - name: Download Building files
      uses: actions/download-artifact@v4
      if: ${{ inputs.content != '' }}
      with:
        name: ${{ inputs.content }}

    - name: Before Image Building
      shell: bash
      if: ${{ inputs.before_building != '' }}
      run: ${{ inputs.before_building }}

    - name: "Building and Pushing Image"
      shell: bash
      run: |
        IMAGE_NAME=${{ inputs.image }}
        IMAGE_TAG=${{ inputs.tag }}
        ECR_URI=${{ steps.login-ecr.outputs.registry }}

        docker build -t $IMAGE_NAME:$IMAGE_TAG ${{ inputs.build_args }} .

        docker tag $IMAGE_NAME:$IMAGE_TAG $ECR_URI/$IMAGE_NAME:$IMAGE_TAG

        docker push $ECR_URI/$IMAGE_NAME:$IMAGE_TAG

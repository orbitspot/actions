name: Api Gateway

on:
  workflow_call:
    inputs:
      module:
        required: true
        type: string
      docs:
        required: true
        type: string
      istio_enabled:
        required: false
        type: string
        default: "true"
      hosts:
        required: false
        type: string
        default: "${{ vars.ISTIO_HOST }}"
      resource_name:
        required: false
        type: string
        default: ""
        
concurrency:
  group: '${{ github.workflow }}-${{ github.ref }}'
  cancel-in-progress: true

jobs:
  get-aws-account:
    name: Get AWS Account Number
    runs-on: ubuntu-latest
    outputs:
      account-number: ${{ steps.get-account.outputs.account-number }}
    steps:
      - name: Get AWS Account Number
        id: get-account
        uses: orbitspot/actions/.github/actions/get-aws-account-number@v21
        with:
          aws_account_number_json: ${{ vars._AWS_ACCOUNT_NUMBER }}

  create-api-gateway:
    name: Create
    runs-on: [ '${{ github.ref_name }}', '${{ inputs.module }}', linux, self-hosted, x64]
    needs: [get-aws-account]
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - uses: hashicorp/setup-terraform@v3
        name: setup
        with:
          terraform_version: 1.5.0

      - name: Start
        uses: orbitspot/actions/.github/actions/api-gateway@v21
        env:
          AWS_ROLE_NAME: ${{ vars.AWS_ROLE_NAME }}
          AWS_REGION: ${{ vars._AWS_REGION }}
          AWS_ACCOUNT_NUMBER: ${{ needs.get-aws-account.outputs.account-number }}
          TF_VAR_branch: '${{ github.ref_name }}'
          TF_VAR_repository_name: '${{ github.event.repository.name }}'
          TF_VAR_hosts: '${{ inputs.hosts }}'
          TF_VAR_docs: '${{ inputs.docs }}'
          TF_VAR_istio_enabled: '${{ inputs.istio_enabled }}'
          TF_VAR_resource_name: '${{ inputs.resource_name }}'
          TF_VAR_api_gateway: '${{ vars._API_GATEWAY }}'
        with:
          tag: 'v21'
      
      - name: Clean up machine
        shell: bash
        run: |
          rm -rf /opt/actions-runner/_work/${{ github.repository }}/*
          df -h
